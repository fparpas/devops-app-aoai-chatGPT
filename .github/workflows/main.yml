name: Deploy Infrastructure

on: 
   workflow_dispatch:
    inputs:
      Environment:
        description: 'Log level'
        required: true
        default: 'Development'
        type: choice
        options:
          - Development
          - QA
          - Production

jobs:
  Deploy:
    name: Deploy ${{ github.event.inputs.Environment }} Environment
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.Environment }}
    steps:
      - name: Script Debug
        run: |
         echo  ${{ vars.RESOURCE_GROUP_NAME }} \
         echo  ${{ github.event.inputs.Environment }} \
         
      - name: Checkout
        uses: actions/checkout@v4.0.0
        
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - uses: Azure/CLI@v1
        with:
          inlineScript: |
            #!/bin/bash
            az account set --subscription ${{ vars.SUBSCRIPTION_ID }}
            az group create --name ${{ vars.RESOURCE_GROUP_NAME }} --location ${{ vars.RESOURCE_GROUP_LOCATION }}
            echo "Azure resource group created"
            
	   - name: Deploy Services with Bicep
        uses: Azure/arm-deploy@v1.0.9
        with:
          scope: resourcegroup
          subscriptionId: ${{ vars.SUBSCRIPTION_ID }}
          resourceGroupName: ${{env.RESOURCE_GROUP_NAME}}
          # Incremental (only add resources to resource group) or Complete (remove extra resources from resource group) or Validate (only validates the template).
          deploymentMode: Incremental
          template: 
          parameters: # optional

  
